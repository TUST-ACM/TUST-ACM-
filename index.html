<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUST-ACMç®—æ³•å®éªŒå®¤å‘¨èµ›æ’åç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white; padding: 2rem 0; margin-bottom: 2rem;
            border-radius: 0 0 10px 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: none; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eaeaea; font-weight: 600; padding: 15px 20px; border-radius: 10px 10px 0 0 !important; }
        .table th { background-color: #f1f5fd; font-weight: 600; vertical-align: middle; }
        .table td { vertical-align: middle; }
        .ranking-badge {
            display: inline-block; width: 28px; height: 28px; line-height: 28px;
            text-align: center; border-radius: 50%; background-color: #f0f0f0;
            color: #333; font-weight: bold; margin-right: 8px; border: 1px solid #ddd;
        }
        .ranking-1 { background-color: #ffd700; color: white; border: none; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
        .ranking-2 { background-color: #c0c0c0; color: white; border: none; }
        .ranking-3 { background-color: #cd7f32; color: white; border: none; }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { color: #4e73df; border-bottom: 3px solid #4e73df; font-weight: 700; }
        .admin-panel { border: 2px dashed #4e73df; background-color: #f8fbff; }
        .score-input { width: 80px; text-align: center; }
        .highlight-update { animation: flashGreen 2s ease-out; }
        @keyframes flashGreen { 0% { background-color: #d4edda; } 100% { background-color: transparent; } }
        .stats-card { text-align: center; padding: 20px; }
        .stats-value { font-size: 2rem; font-weight: 700; color: #4e73df; }
        .motivation-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; padding: 25px; border-radius: 10px; margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .training-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; }
        .website-icon { font-size: 2rem; margin-bottom: 15px; color: #4e73df; }
        .website-card { transition: transform 0.3s; height: 100%; }
        .website-card:hover { transform: translateY(-5px); }
        .makeup-yes { color: #28a745; font-weight: bold; }
        .makeup-no { color: #6c757d; }
        .loading-overlay { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; color: #6c757d; }
    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <h1 class="display-5 fw-bold">TUST-ACMç®—æ³•å®éªŒå®¤</h1>
        <p class="lead">å‘¨èµ›æ’åä¸ç»Ÿè®¡æ•°æ®ä¸­å¿ƒ</p>
    </div>
</div>

<div class="container">
    <div class="motivation-section text-center">
        <h3 class="mb-3"> èµ¤å­ä¹‹å¿ƒå²‚å›šåœ¨å¤œï¼Œåå¹´é¥®å†°éš¾å‡‰çƒ­è¡€ï¼</h3>
        <p class="mb-0">"æ¯ä¸€æ¬¡åˆ·é¢˜éƒ½æ˜¯ç§¯ç´¯ï¼Œæ¯ä¸€åœºæ¯”èµ›éƒ½æ˜¯æˆé•¿ã€‚ä¸è¦å®³æ€•æš‚æ—¶çš„è½åï¼Œé‡è¦çš„æ˜¯æŒç»­è¿›æ­¥ï¼"</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3"><div class="card stats-card"><div class="stats-value">18</div><div class="stats-label">å‚èµ›æˆå‘˜</div></div></div>
        <div class="col-md-3"><div class="card stats-card"><div class="stats-value" id="contest-count">-</div><div class="stats-label">å·²ä¸¾åŠåœºæ¬¡</div></div></div>
        <div class="col-md-3"><div class="card stats-card"><div class="stats-value" id="max-score-display">-</div><div class="stats-label">æœ€é«˜ç§¯åˆ†</div></div></div>
        <div class="col-md-3"><div class="card stats-card"><div class="stats-value">14</div><div class="stats-label">å®Œæˆè¡¥é¢˜äººæ•°</div></div></div>
    </div>

    <!-- ç®¡ç†å‘˜åŒºåŸŸ -->
    <div class="card admin-panel mt-4 mb-4">
        <div class="card-header bg-transparent text-primary d-flex justify-content-between align-items-center">
            <span><i class="bi bi-cloud-arrow-up"></i> â• ç®¡ç†å‘˜æ§åˆ¶å°ï¼šæ–°å‘¨èµ›ç»“ç®—</span>
            <div>
                <!-- æ–°å¢ï¼šä¿®æ­£æŒ‰é’® -->
                <button class="btn btn-outline-warning btn-sm me-2" onclick="openEditModal()">
                    <i class="bi bi-wrench-adjustable"></i> ä¿®æ­£å¾€æœŸæ•°æ®
                </button>
                <span class="badge bg-primary">äº‘ç«¯åŒæ­¥ç‰ˆ</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">æ¯”èµ›æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="new-contest-date">
                </div>
                <div class="col-md-8">
                    <p class="text-muted small mt-4">è¾“å…¥å¾—åˆ†å¹¶æäº¤ã€‚ç³»ç»Ÿå°†è¦æ±‚è¾“å…¥ <b>API Key</b> å¯†ç ï¼ŒéªŒè¯é€šè¿‡åæ•°æ®å°†æ°¸ä¹…ä¿å­˜åˆ°äº‘ç«¯ã€‚</p>
                </div>
            </div>

            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                <table class="table table-sm table-bordered">
                    <thead class="table-light sticky-top">
                    <tr>
                        <th>å§“å</th>
                        <th>å½“å‰æ€»åˆ†</th>
                        <th width="140">æœ¬åœºæ’ååˆ†</th>
                        <th width="100">è¡¥é¢˜ (+1)</th>
                        <th>æœ¬åœºæ–°å¢</th>
                    </tr>
                    </thead>
                    <tbody id="input-score-body">
                    <tr><td colspan="5" class="text-center">æ­£åœ¨åŠ è½½äº‘ç«¯åå•...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" id="submit-btn" onclick="submitAndGenerateReport()" disabled>
                    ğŸš€ æäº¤ç»“ç®—å¹¶åŒæ­¥åˆ°äº‘ç«¯
                </button>
            </div>
        </div>
    </div>

    <!-- æ€»æ’åè¡¨ -->
    <div class="card mt-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <span>ğŸ† å®éªŒå®¤æ€»æ’åè¡¨ (å®æ—¶æ›´æ–°)</span>
            <small id="last-update-text" style="opacity: 0.8">æ›´æ–°æ—¶é—´: åŠ è½½ä¸­...</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 table-striped">
                    <thead>
                    <tr>
                        <th width="15%">æ€»æ’å</th>
                        <th width="35%">å§“å</th>
                        <th width="25%">çŠ¶æ€</th>
                        <th width="25%">æ€»ç§¯åˆ†</th>
                    </tr>
                    </thead>
                    <tbody id="total-ranking-table">
                    <tr><td colspan="4" class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">æ­£åœ¨è¿æ¥äº‘æ•°æ®åº“è·å–æœ€æ–°æ’å...</p></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å†å²æ¯”èµ›è¯¦æƒ… -->
    <h4 class="mt-5 mb-3">ğŸ“Š å†å²å‘¨èµ›è¯¦æƒ…</h4>
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="contestTabs" role="tablist"></ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="contestTabsContent">
                <div class="loading-overlay"><div class="spinner-border text-secondary" role="status"></div><p class="mt-2">åŠ è½½æ¯”èµ›è®°å½•...</p></div>
            </div>
        </div>
    </div>

    <!-- å…¶ä»–é™æ€å†…å®¹åŒºåŸŸ (ä¿ç•™) -->
    <div class="card mt-4">
        <div class="card-header"><h5 class="mb-0">ğŸ“š å¹³æ—¶è®­ç»ƒä¸“é¢˜é¢˜åº“</h5></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3"><div class="card training-card h-100"><div class="training-header"><h5 class="mb-1">ç¬¬ä¸€ç« </h5><p class="mb-0 small">åŸºç¡€å…¥é—¨</p></div><div class="card-body p-3"><a href="https://vjudge.net/contest/758792" class="btn btn-sm btn-outline-primary w-100" target="_blank">è¿›å…¥é¢˜åº“</a></div></div></div>
                <div class="col-md-4 mb-3"><div class="card training-card h-100"><div class="training-header"><h5 class="mb-1">ç¬¬äºŒéƒ¨åˆ†</h5><p class="mb-0 small">éš¾åº¦ä¸­ç­‰</p></div><div class="card-body p-3"><a href="https://vjudge.net/contest/763313" class="btn btn-sm btn-outline-primary w-100" target="_blank">è¿›å…¥é¢˜åº“</a></div></div></div>
                <div class="col-md-4 mb-3"><div class="card training-card h-100"><div class="training-header"><h5 class="mb-1">ç¬¬ä¸‰éƒ¨åˆ†</h5><p class="mb-0 small">æ•°æ®ç»“æ„</p></div><div class="card-body p-3"><a href="https://vjudge.net/contest/769367" class="btn btn-sm btn-outline-primary w-100" target="_blank">è¿›å…¥é¢˜åº“</a></div></div></div>
            </div>
        </div>
    </div>
    
    <!-- XCPC & åˆ·é¢˜ç½‘ç«™ (ä»£ç ç•¥å¾®æŠ˜å ä»¥ä¿æŒæ•´æ´ï¼Œå†…å®¹ä¸å˜) -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center"><span>XCPCå‘¨èµ›æƒ…å†µ</span><a href="https://www.cnblogs.com/WIDA/p/18122995#5312410" class="btn btn-sm btn-outline-primary" target="_blank">æŸ¥çœ‹åˆ—è¡¨</a></div>
        <div class="card-body p-0"><table class="table table-hover mb-0"><thead><tr><th>æ’å</th><th>æ¯”èµ›åç§°</th><th>æ—¥æœŸ</th><th>é˜Ÿä¼æ•°</th></tr></thead><tbody id="xcpc-table"></tbody></table></div>
    </div>
    <div class="card mt-4 mb-5">
        <div class="card-header"><h5 class="mb-0">ğŸ“š æ¨èåˆ·é¢˜ç½‘ç«™</h5></div>
        <div class="card-body"><div class="row text-center"><div class="col-md-4 mb-2"><a href="https://codeforces.com/" class="btn btn-outline-primary w-100" target="_blank">Codeforces</a></div><div class="col-md-4 mb-2"><a href="https://www.luogu.com.cn/" class="btn btn-outline-success w-100" target="_blank">æ´›è°·</a></div><div class="col-md-4"><a href="https://ac.nowcoder.com/" class="btn btn-outline-danger w-100" target="_blank">ç‰›å®¢ç½‘</a></div></div></div>
    </div>
    
    <footer class="text-center mt-5"><p>TUST-ACMç®—æ³•å®éªŒå®¤ &copy; 2025</p></footer>
</div>

<!-- ä¿®æ­£æ•°æ®çš„ Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-wrench-adjustable"></i> ä¿®æ­£å¾€æœŸæ•°æ®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">é€‰æ‹©è¦ä¿®æ­£çš„åœºæ¬¡ï¼š</label>
                    <select class="form-select" id="edit-contest-select" onchange="loadContestForEditing()">
                        <!-- JS å¡«å…… -->
                    </select>
                </div>
                <div class="alert alert-warning small">
                    <i class="bi bi-exclamation-triangle"></i> æ³¨æ„ï¼šä¿®æ”¹æ­¤å¤„åˆ†æ•°åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—è¯¥åœºæ¬¡çš„æ’åä»¥åŠæ€»ç§¯åˆ†æ¦œã€‚è¯·è°¨æ…æ“ä½œã€‚
                </div>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light sticky-top">
                        <tr>
                            <th>å§“å</th>
                            <th>æ’ååˆ† (Raw)</th>
                            <th>è¡¥é¢˜ (MakeUp)</th>
                            <th>æœ¬åœºæ€»å¾—åˆ†</th>
                        </tr>
                        </thead>
                        <tbody id="edit-score-body">
                        <!-- JS å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="save-edit-btn" onclick="saveEditedData()">ä¿å­˜ä¿®æ­£å¹¶åŒæ­¥</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // =========================================================================
    // âš ï¸ å…³é”®é…ç½®åŒºï¼šè¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ JsonBin Bin ID
    // =========================================================================

    const BIN_ID = '692d62fdd0ea881f400b2564';

    // =========================================================================

    let db = { contestCount: 0, lastUpdate: "", totalRanking: [], contests: {} };
    const xcpcData = [
        { rank: "491/1630", contestName: "2023 å¹¿ä¸œ CPC", date: "2025-11-2", participants: "1630", link: "https://codeforces.com/gym/104369/standings" },
        { rank: "305/1238", contestName: "2022 æ²³å— CPC", date: "2025-11-9", participants: "1238", link: "https://codeforces.com/gym/103941/standings" },
        { rank: "201/468", contestName: "2023 æ¹–å— CPC", date: "2025-11-16", participants: "468", link: "https://codeforces.com/gym/104396/standings/page/2" },
        { rank: "467/1622", contestName: "2023 æ¹–åŒ— CPC", date: "2025-11-23", participants: "1622", link: "https://codeforces.com/gym/104337/standings/friends/true" },
        { rank: "704/2035", contestName: "2024 æ­¦æ±‰ ICPCé›†è®­é˜Ÿ", date: "2025-11-30", participants: "2035", link: "https://codeforces.com/gym/105143/standings" }
    ];

    document.addEventListener('DOMContentLoaded', async function() {
        document.getElementById('new-contest-date').valueAsDate = new Date();
        renderXcpcTable();
        try {
            await loadDataFromCloud();
            refreshAllViews();
            initInputTable();
            document.getElementById('submit-btn').disabled = false;
        } catch (error) {
            console.error("åŠ è½½å¤±è´¥:", error);
            document.getElementById('total-ranking-table').innerHTML = `<tr><td colspan="4" class="text-center text-danger p-5"><h5>æ•°æ®åŠ è½½å¤±è´¥</h5><p>${error.message}</p></td></tr>`;
        }
    });

    // ================= äº‘ç«¯äº¤äº’ =================
    async function loadDataFromCloud() {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {});
        if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
        const json = await response.json();
        if (json.record) { db = json.record; } else { throw new Error("äº‘ç«¯æ•°æ®æ ¼å¼å¼‚å¸¸"); }
    }

    async function saveDataToCloud(apiKey) {
        db.lastUpdate = new Date().toLocaleString();
        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': apiKey },
            body: JSON.stringify(db)
        });
        if (!response.ok) {
            if(response.status === 401) throw new Error("API Key é”™è¯¯");
            throw new Error(`ä¿å­˜å¤±è´¥ (Status ${response.status})`);
        }
        return await response.json();
    }

    // ================= è§†å›¾æ¸²æŸ“ =================
    function refreshAllViews() {
        document.getElementById('contest-count').innerText = db.contestCount;
        document.getElementById('last-update-text').innerText = `æ›´æ–°æ—¶é—´: ${db.lastUpdate || 'æœªçŸ¥'}`;
        if(db.totalRanking && db.totalRanking.length > 0) {
            document.getElementById('max-score-display').innerText = db.totalRanking[0].totalScore;
        }
        renderTotalTable(db.totalRanking);

        const tabList = document.getElementById('contestTabs');
        const tabContent = document.getElementById('contestTabsContent');
        tabList.innerHTML = '';
        tabContent.innerHTML = '';

        if(db.contests) {
            const keys = Object.keys(db.contests).sort((a, b) => parseInt(b.replace('c', '')) - parseInt(a.replace('c', '')));
            if(keys.length === 0) {
                tabContent.innerHTML = '<div class="p-5 text-center text-muted">æš‚æ— æ¯”èµ›è®°å½•</div>';
            } else {
                keys.forEach((key, index) => {
                    const id = key.replace('c', '');
                    const data = db.contests[key];
                    const isActive = index === 0;
                    createContestTabHTML(id, isActive, data);
                });
            }
        }
    }

    function createContestTabHTML(id, isActive, data) {
        const tabId = `c${id}`;
        const chartId = `scoreChart${id}`;
        const tableId = `ranking-table-${id}`;
        
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = `<button class="nav-link ${isActive?'active':''}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button">ç¬¬${id}åœº</button>`;
        document.getElementById('contestTabs').appendChild(li);

        const pane = document.createElement('div');
        pane.className = `tab-pane fade ${isActive?'show active':''}`;
        pane.id = tabId;
        pane.innerHTML = `
            <div class="row pt-3"><div class="col-lg-8"><div class="card border-0 shadow-sm"><div class="card-header bg-light">ç¬¬${id}åœºå‘¨èµ›æ’åè¯¦æƒ…</div><div class="card-body p-0"><div class="table-responsive"><table class="table table-hover mb-0"><thead><tr><th>æ€»æ’</th><th>å§“å</th><th>æœ¬åœºè¯¦æƒ…</th><th>è¡¥é¢˜</th><th>æœ¬åœºç§¯åˆ†</th></tr></thead><tbody id="${tableId}"></tbody></table></div></div></div></div><div class="col-lg-4"><div class="card border-0 shadow-sm h-100"><div class="card-body text-center"><h6 class="text-muted mb-3">ç¬¬${id}åœºå¾—åˆ†åˆ†å¸ƒ</h6><div style="height:200px"><canvas id="${chartId}"></canvas></div></div></div></div></div>
        `;
        document.getElementById('contestTabsContent').appendChild(pane);

        renderContestTable(tableId, data);
        setTimeout(() => { renderChart(chartId, data); }, 100);
    }

    // ================= æäº¤æ–°æ¯”èµ›é€»è¾‘ =================
    async function submitAndGenerateReport() {
        const inputs = document.querySelectorAll('.contest-score');
        const checks = document.querySelectorAll('.makeup-check');
        let currentContestResults = [];
        let hasData = false;

        inputs.forEach((input, idx) => {
            const name = input.getAttribute('data-name');
            const score = parseInt(input.value) || 0;
            const isMakeup = checks[idx].checked;
            const totalAdded = score + (isMakeup ? 1 : 0);

            if (totalAdded > 0) {
                hasData = true;
                const student = db.totalRanking.find(s => s.name === name);
                if (student) { student.totalScore += totalAdded; student.justUpdated = true; }
                currentContestResults.push({ name: name, rawScore: score, makeup: isMakeup, totalScore: totalAdded });
            }
        });

        if (!hasData) { alert("æœªæ£€æµ‹åˆ°åˆ†æ•°è¾“å…¥ï¼"); return; }
        const apiKey = prompt("æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...\n\nè¯·è¾“å…¥ç®¡ç†å‘˜ API Key:");
        if (!apiKey) return;

        const btn = document.getElementById('submit-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ æ­£åœ¨åŒæ­¥...';
        btn.disabled = true;

        try {
            db.totalRanking.sort((a, b) => b.totalScore - a.totalScore);
            db.contestCount++;
            const newKey = `c${db.contestCount}`;
            currentContestResults.sort((a, b) => b.totalScore - a.totalScore);
            const formattedContestData = currentContestResults.map((item, index) => {
                const globalRank = db.totalRanking.findIndex(s => s.name === item.name) + 1;
                return {
                    totalRank: globalRank,
                    name: item.name,
                    contestRank: item.rawScore > 0 ? `${index + 1} â†’ +${item.rawScore}` : "-",
                    makeUp: item.makeup ? "+1" : "",
                    totalScore: item.totalScore,
                    rawScore: item.rawScore // ä¿å­˜åŸå§‹åˆ†æ–¹ä¾¿åç»­ä¿®æ­£
                };
            });
            db.contests[newKey] = formattedContestData;
            await saveDataToCloud(apiKey);
            alert("âœ… åŒæ­¥æˆåŠŸï¼");
            refreshAllViews();
            initInputTable();
        } catch (err) {
            alert("âŒ ä¿å­˜å¤±è´¥: " + err.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            setTimeout(() => { db.totalRanking.forEach(s => s.justUpdated = false); }, 2000);
        }
    }

    // ================= ä¿®æ­£æ•°æ®é€»è¾‘ (æ–°å¢) =================
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal() {
        const select = document.getElementById('edit-contest-select');
        select.innerHTML = '<option value="">è¯·é€‰æ‹©åœºæ¬¡...</option>';
        // å€’åºåŠ è½½åœºæ¬¡
        const keys = Object.keys(db.contests).sort((a, b) => parseInt(b.replace('c', '')) - parseInt(a.replace('c', '')));
        keys.forEach(key => {
            select.innerHTML += `<option value="${key}">ç¬¬ ${key.replace('c', '')} åœº</option>`;
        });
        document.getElementById('edit-score-body').innerHTML = '';
        editModal.show();
    }

    function loadContestForEditing() {
        const key = document.getElementById('edit-contest-select').value;
        const tbody = document.getElementById('edit-score-body');
        tbody.innerHTML = '';
        if (!key) return;

        const contestData = db.contests[key];
        // åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰æ€»æ¦œé‡Œçš„äººï¼Œå¦‚æœåœ¨è¯¥åœºæ¬¡æœ‰åˆ†åˆ™å¡«å…¥ï¼Œæ— åˆ†åˆ™ä¸º0ï¼Œå…è®¸è¡¥å½•
        // ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬åŸºäº db.totalRanking æ¥åˆ—å‡ºåå•
        const sortedStudents = [...db.totalRanking].sort((a, b) => a.name.localeCompare(b.name));

        sortedStudents.forEach(student => {
            // æŸ¥æ‰¾è¯¥å­¦ç”Ÿåœ¨è¯¥åœºæ¬¡çš„è®°å½•
            const record = contestData.find(r => r.name === student.name);
            const rawScore = record ? (record.rawScore !== undefined ? record.rawScore : extractScoreFromStr(record.contestRank)) : 0;
            const isMakeup = record ? (record.makeUp === "+1" || record.makeUp === true) : false;
            const currentTotal = record ? record.totalScore : 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${student.name}</td>
                <td><input type="number" class="form-control form-control-sm edit-raw-score" data-name="${student.name}" data-old-total="${currentTotal}" value="${rawScore}" oninput="calcEditRow(this)"></td>
                <td><div class="form-check d-flex justify-content-center"><input class="form-check-input edit-makeup" type="checkbox" ${isMakeup ? 'checked' : ''} onchange="calcEditRow(this)"></div></td>
                <td class="fw-bold" id="edit-total-${student.name}">${currentTotal}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // è¾…åŠ©ï¼šä» "1 -> +7" å­—ç¬¦ä¸²ä¸­æå– 7ã€‚å¦‚æœæ ¼å¼ä¸å¯¹ï¼ˆæ—§æ•°æ®ï¼‰ï¼Œå°è¯•åæ¨
    function extractScoreFromStr(str) {
        if (!str || str === "-") return 0;
        const match = str.match(/\+(\d+)/);
        return match ? parseInt(match[1]) : 0;
    }

    function calcEditRow(el) {
        const row = el.closest('tr');
        const rawScore = parseInt(row.querySelector('.edit-raw-score').value) || 0;
        const makeup = row.querySelector('.edit-makeup').checked ? 1 : 0;
        row.querySelector('td:last-child').innerText = rawScore + makeup;
    }

    async function saveEditedData() {
        const key = document.getElementById('edit-contest-select').value;
        if (!key) return;

        const apiKey = prompt("è¯·è¾“å…¥ API Key ç¡®è®¤ä¿®æ”¹ï¼š");
        if (!apiKey) return;

        const inputs = document.querySelectorAll('.edit-raw-score');
        let newContestData = [];

        // 1. éå†ç¼–è¾‘è¡¨å•ï¼Œè®¡ç®—å·®å€¼å¹¶æ›´æ–°æ€»æ¦œ
        inputs.forEach(input => {
            const name = input.getAttribute('data-name');
            const oldContestTotal = parseInt(input.getAttribute('data-old-total')) || 0;
            
            const row = input.closest('tr');
            const newRaw = parseInt(input.value) || 0;
            const newMakeup = row.querySelector('.edit-makeup').checked;
            const newContestTotal = newRaw + (newMakeup ? 1 : 0);

            // è®¡ç®—å·®å€¼
            const diff = newContestTotal - oldContestTotal;

            // æ›´æ–°æ€»æ¦œ
            if (diff !== 0) {
                const student = db.totalRanking.find(s => s.name === name);
                if (student) {
                    student.totalScore += diff;
                }
            }

            // åªæœ‰å½“è¯¥åœºæ¬¡å¾—åˆ†ä¸ºæ­£ï¼Œæ‰å­˜å…¥è¯¥åœºæ¬¡è®°å½•
            if (newContestTotal > 0) {
                newContestData.push({
                    name: name,
                    rawScore: newRaw,
                    makeup: newMakeup,
                    totalScore: newContestTotal
                });
            }
        });

        // 2. é‡æ–°æ’åºæ€»æ¦œ
        db.totalRanking.sort((a, b) => b.totalScore - a.totalScore);

        // 3. é‡æ–°æ’åºè¯¥åœºæ¬¡æ•°æ®ï¼Œå¹¶é‡æ–°ç”Ÿæˆ Rank å­—ç¬¦ä¸²
        newContestData.sort((a, b) => b.totalScore - a.totalScore);
        
        const formattedData = newContestData.map((item, index) => {
             const globalRank = db.totalRanking.findIndex(s => s.name === item.name) + 1;
             return {
                 totalRank: globalRank,
                 name: item.name,
                 contestRank: item.rawScore > 0 ? `${index + 1} â†’ +${item.rawScore}` : "-",
                 makeUp: item.makeup ? "+1" : "",
                 totalScore: item.totalScore,
                 rawScore: item.rawScore
             };
        });

        db.contests[key] = formattedData;

        // 4. ä¿å­˜
        const btn = document.getElementById('save-edit-btn');
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        try {
            await saveDataToCloud(apiKey);
            alert("âœ… ä¿®æ­£æˆåŠŸï¼");
            editModal.hide();
            refreshAllViews();
            initInputTable();
        } catch(e) {
            alert("é”™è¯¯ï¼š" + e.message);
        } finally {
            btn.innerText = "ä¿å­˜ä¿®æ­£å¹¶åŒæ­¥";
            btn.disabled = false;
        }
    }

    // ================= è¾…åŠ©å‡½æ•° =================
    function initInputTable() {
        const tbody = document.getElementById('input-score-body');
        tbody.innerHTML = '';
        const sorted = [...db.totalRanking].sort((a, b) => b.totalScore - a.totalScore);
        sorted.forEach(student => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${student.name}</td><td>${student.totalScore}</td><td><input type="number" class="form-control form-control-sm score-input contest-score" data-name="${student.name}" placeholder="0" oninput="calcPreview(this)"></td><td><div class="form-check d-flex justify-content-center"><input class="form-check-input makeup-check" type="checkbox" data-name="${student.name}" onchange="calcPreview(this)"></div></td><td class="text-primary fw-bold" id="added-${student.name}">0</td>`;
            tbody.appendChild(tr);
        });
    }

    function calcPreview(el) {
        const row = el.closest('tr');
        const score = parseInt(row.querySelector('.contest-score').value) || 0;
        const makeup = row.querySelector('.makeup-check').checked ? 1 : 0;
        const added = score + makeup;
        row.querySelector('td:last-child').innerText = added > 0 ? `+${added}` : 0;
    }

    function renderTotalTable(data) {
        const tbody = document.getElementById('total-ranking-table');
        tbody.innerHTML = '';
        if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>'; return; }
        data.forEach((item, index) => {
            let displayRank = index + 1;
            if(index > 0 && item.totalScore === data[index-1].totalScore) displayRank = data[index-1].displayRank || displayRank;
            item.displayRank = displayRank;
            let rankClass = displayRank === 1 ? 'ranking-1' : (displayRank === 2 ? 'ranking-2' : (displayRank === 3 ? 'ranking-3' : ''));
            let statusHtml = displayRank <= 3 ? '<span class="text-success"><i class="bi bi-fire"></i> é¢†è·‘</span>' : '<span class="text-muted"><i class="bi bi-dash"></i> ç¨³å®š</span>';
            tbody.innerHTML += `<tr class="${item.justUpdated ? 'highlight-update' : ''}"><td><span class="ranking-badge ${rankClass}">${displayRank}</span></td><td>${item.name}</td><td>${statusHtml}</td><td><strong>${item.totalScore}</strong></td></tr>`;
        });
    }

    function renderContestTable(elId, data) {
        const tbody = document.getElementById(elId);
        tbody.innerHTML = '';
        if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æ— æ•°æ®</td></tr>'; return; }
        data.forEach(item => {
            let rankClass = item.totalRank === 1 ? 'ranking-1' : (item.totalRank === 2 ? 'ranking-2' : (item.totalRank === 3 ? 'ranking-3' : ''));
            let mkClass = item.makeUp ? 'makeup-yes' : 'makeup-no';
            tbody.innerHTML += `<tr><td><span class="ranking-badge ${rankClass}">${item.totalRank}</span></td><td>${item.name}</td><td>${item.contestRank}</td><td class="${mkClass}">${item.makeUp || '-'}</td><td><strong>${item.totalScore}</strong></td></tr>`;
        });
    }

    function renderChart(canvasId, data) {
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        const existingChart = Chart.getChart(ctx);
        if(existingChart) existingChart.destroy();
        const scores = {};
        if(data) data.forEach(d => { scores[d.totalScore] = (scores[d.totalScore] || 0) + 1; });
        new Chart(ctx, { type: 'pie', data: { labels: Object.keys(scores).map(k => `${k}åˆ†`), datasets: [{ data: Object.values(scores), backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
    }

    function renderXcpcTable() {
        const tbody = document.getElementById('xcpc-table');
        tbody.innerHTML = '';
        xcpcData.forEach(item => { tbody.innerHTML += `<tr><td>${item.rank}</td><td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.contestName}</a></td><td>${item.date}</td><td>${item.participants}</td></tr>`; });
    }
</script>
</body>
</html>
