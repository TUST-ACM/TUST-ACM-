<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TUST-ACMç®—æ³•å®éªŒå®¤å‘¨èµ›æ’åç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white; padding: 2rem 0; margin-bottom: 2rem;
            border-radius: 0 0 10px 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; border: none; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eaeaea; font-weight: 600; padding: 15px 20px; border-radius: 10px 10px 0 0 !important; }
        .table th { background-color: #f1f5fd; font-weight: 600; vertical-align: middle; }
        .table td { vertical-align: middle; }
        .ranking-badge {
            display: inline-block; width: 28px; height: 28px; line-height: 28px;
            text-align: center; border-radius: 50%; background-color: #f0f0f0;
            color: #333; font-weight: bold; margin-right: 8px; border: 1px solid #ddd;
        }
        .ranking-1 { background-color: #ffd700; color: white; border: none; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
        .ranking-2 { background-color: #c0c0c0; color: white; border: none; }
        .ranking-3 { background-color: #cd7f32; color: white; border: none; }

        /* é€‰é¡¹å¡æ ·å¼ */
        .nav-tabs .nav-link { color: #495057; font-weight: 500; }
        .nav-tabs .nav-link.active { color: #4e73df; border-bottom: 3px solid #4e73df; font-weight: 700; }

        /* ç®¡ç†é¢æ¿æ ·å¼ */
        .admin-panel { border: 2px dashed #4e73df; background-color: #f8fbff; }
        .score-input { width: 80px; text-align: center; }
        .highlight-update { animation: flashGreen 2s ease-out; }
        @keyframes flashGreen { 0% { background-color: #d4edda; } 100% { background-color: transparent; } }

        .stats-card { text-align: center; padding: 20px; }
        .stats-value { font-size: 2rem; font-weight: 700; color: #4e73df; }
        .motivation-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; padding: 25px; border-radius: 10px; margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .training-header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px 20px; border-radius: 10px 10px 0 0; }
        .website-icon { font-size: 2rem; margin-bottom: 15px; color: #4e73df; }
        .website-card { transition: transform 0.3s; height: 100%; }
        .website-card:hover { transform: translateY(-5px); }
        .makeup-yes { color: #28a745; font-weight: bold; }
        .makeup-no { color: #6c757d; }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 3rem; color: #6c757d; }
    </style>
</head>
<body>
<div class="header">
    <div class="container">
        <h1 class="display-5 fw-bold">TUST-ACMç®—æ³•å®éªŒå®¤</h1>
        <p class="lead">å‘¨èµ›æ’åä¸ç»Ÿè®¡æ•°æ®ä¸­å¿ƒ</p>
    </div>
</div>

<div class="container">
    <!-- åŠ±å¿—è¯­åŒºåŸŸ -->
    <div class="motivation-section text-center">
        <h3 class="mb-3"> èµ¤å­ä¹‹å¿ƒå²‚å›šåœ¨å¤œï¼Œåå¹´é¥®å†°éš¾å‡‰çƒ­è¡€ï¼</h3>
        <p class="mb-0">"æ¯ä¸€æ¬¡åˆ·é¢˜éƒ½æ˜¯ç§¯ç´¯ï¼Œæ¯ä¸€åœºæ¯”èµ›éƒ½æ˜¯æˆé•¿ã€‚ä¸è¦å®³æ€•æš‚æ—¶çš„è½åï¼Œé‡è¦çš„æ˜¯æŒç»­è¿›æ­¥ï¼"</p>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ (æ•°æ®åŠ¨æ€åŠ è½½) -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-value">18</div>
                <div class="stats-label">å‚èµ›æˆå‘˜</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-value" id="contest-count">-</div>
                <div class="stats-label">å·²ä¸¾åŠåœºæ¬¡</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-value" id="max-score-display">-</div>
                <div class="stats-label">æœ€é«˜ç§¯åˆ†</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="stats-value">14</div>
                <div class="stats-label">å®Œæˆè¡¥é¢˜äººæ•°</div>
            </div>
        </div>
    </div>

    <!-- ================= ç®¡ç†å‘˜åŒºåŸŸï¼šå½•å…¥å¹¶åŒæ­¥åˆ°äº‘ç«¯ ================= -->
    <div class="card admin-panel mt-4 mb-4">
        <div class="card-header bg-transparent text-primary d-flex justify-content-between align-items-center">
            <span><i class="bi bi-cloud-arrow-up"></i> â• ç®¡ç†å‘˜æ§åˆ¶å°ï¼šæ–°å‘¨èµ›ç»“ç®—</span>
            <span class="badge bg-primary">äº‘ç«¯åŒæ­¥ç‰ˆ</span>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">æ¯”èµ›æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="new-contest-date">
                </div>
                <div class="col-md-8">
                    <p class="text-muted small mt-4">è¾“å…¥å¾—åˆ†å¹¶æäº¤ã€‚ç³»ç»Ÿå°†è¦æ±‚è¾“å…¥ <b>API Key</b> å¯†ç ï¼ŒéªŒè¯é€šè¿‡åæ•°æ®å°†æ°¸ä¹…ä¿å­˜åˆ°äº‘ç«¯ã€‚</p>
                </div>
            </div>

            <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                <table class="table table-sm table-bordered">
                    <thead class="table-light sticky-top">
                    <tr>
                        <th>å§“å</th>
                        <th>å½“å‰æ€»åˆ†</th>
                        <th width="140">æœ¬åœºæ’ååˆ†</th>
                        <th width="100">è¡¥é¢˜ (+1)</th>
                        <th>æœ¬åœºæ–°å¢</th>
                    </tr>
                    </thead>
                    <tbody id="input-score-body">
                    <tr><td colspan="5" class="text-center">æ­£åœ¨åŠ è½½äº‘ç«¯åå•...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" id="submit-btn" onclick="submitAndGenerateReport()" disabled>
                    ğŸš€ æäº¤ç»“ç®—å¹¶åŒæ­¥åˆ°äº‘ç«¯
                </button>
            </div>
        </div>
    </div>

    <!-- æ€»æ’åè¡¨ -->
    <div class="card mt-4 border-primary">
        <div class="card-header bg-primary text-white d-flex justify-content-between">
            <span>ğŸ† å®éªŒå®¤æ€»æ’åè¡¨ (å®æ—¶æ›´æ–°)</span>
            <small id="last-update-text" style="opacity: 0.8">æ›´æ–°æ—¶é—´: åŠ è½½ä¸­...</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 table-striped">
                    <thead>
                    <tr>
                        <th width="15%">æ€»æ’å</th>
                        <th width="35%">å§“å</th>
                        <th width="25%">çŠ¶æ€</th>
                        <th width="25%">æ€»ç§¯åˆ†</th>
                    </tr>
                    </thead>
                    <tbody id="total-ranking-table">
                    <!-- åŠ è½½åŠ¨ç”»å ä½ -->
                    <tr>
                        <td colspan="4" class="text-center p-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">æ­£åœ¨è¿æ¥äº‘æ•°æ®åº“è·å–æœ€æ–°æ’å...</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- å†å²æ¯”èµ›è¯¦æƒ… (åŠ¨æ€ç”Ÿæˆçš„ Tabs) -->
    <h4 class="mt-5 mb-3">ğŸ“Š å†å²å‘¨èµ›è¯¦æƒ…</h4>
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="contestTabs" role="tablist">
                <!-- JS å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ Tabs -->
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="contestTabsContent">
                <!-- JS å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥å†…å®¹ -->
                <div class="loading-overlay">
                    <div class="spinner-border text-secondary" role="status"></div>
                    <p class="mt-2">åŠ è½½æ¯”èµ›è®°å½•...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¹³æ—¶è®­ç»ƒä¸“é¢˜é¢˜åº“ (é™æ€èµ„æ–™) -->
    <div class="card mt-4">
        <div class="card-header"><h5 class="mb-0">ğŸ“š å¹³æ—¶è®­ç»ƒä¸“é¢˜é¢˜åº“</h5></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card training-card h-100">
                        <div class="training-header"><h5 class="mb-1">ç¬¬ä¸€ç« </h5><p class="mb-0 small">2025.10.20 - 2025.11.03</p></div>
                        <div class="card-body p-3">
                            <p class="mb-3">è¯­è¨€åŸºç¡€ï¼Œæ•°ç»„åŸºç¡€ï¼Œå­—ç¬¦ä¸²ï¼Œç®€å•æ•°å­¦ï¼Œè´ªå¿ƒï¼ŒäºŒåˆ†</p>
                            <a href="https://vjudge.net/contest/758792" class="btn btn-sm btn-outline-primary w-100" target="_blank">è¿›å…¥é¢˜åº“ (åŸºç¡€)</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card training-card h-100">
                        <div class="training-header"><h5 class="mb-1">ç¬¬äºŒéƒ¨åˆ†</h5><p class="mb-0 small">2025.11.03 - 2025.12.03</p></div>
                        <div class="card-body p-3">
                            <p class="mb-3">åŒæŒ‡é’ˆï¼Œå¤§æ¨¡æ‹Ÿï¼Œæ’åºï¼ŒäºŒåˆ†ç®—æ³•ï¼Œæ€ç»´é¢˜</p>
                            <a href="https://vjudge.net/contest/763313" class="btn btn-sm btn-outline-primary w-100" target="_blank">è¿›å…¥é¢˜åº“ (ä¸­ç­‰)</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card training-card h-100">
                        <div class="training-header"><h5 class="mb-1">ç¬¬ä¸‰éƒ¨åˆ†</h5><p class="mb-0 small">2025.11.24 - 2025.12.09</p></div>
                        <div class="card-body p-3">
                            <p class="mb-3">å †æ ˆé˜Ÿåˆ—å•è°ƒæ ˆï¼ŒSTLç”¨æ³•ï¼Œæ•°æ®ç»“æ„åŸºç¡€</p>
                            <a href="https://vjudge.net/contest/769367" class="btn btn-sm btn-outline-primary w-100" target="_blank">è¿›å…¥é¢˜åº“ (è¿›é˜¶)</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- XCPCå‘¨èµ›æƒ…å†µè¡¨æ ¼ (é™æ€èµ„æ–™) -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>XCPCå‘¨èµ›æƒ…å†µï¼š</span>
            <div>
                <span class="contest-type-badge me-2">XCPCÂ VP</span>
                <a href="https://www.cnblogs.com/WIDA/p/18122995#5312410" class="btn btn-sm btn-outline-primary" target="_blank">æŸ¥çœ‹æ¯”èµ›åˆ—è¡¨</a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                    <tr><th width="20%">æ’å</th><th width="30%">æ¯”èµ›åç§°</th><th width="25%">æ¯”èµ›æ—¥æœŸ</th><th width="25%">å‚èµ›é˜Ÿä¼æ•°</th></tr>
                    </thead>
                    <tbody id="xcpc-table">
                    <!-- JS ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- åˆ·é¢˜ç½‘ç«™æ¨è (é™æ€èµ„æ–™) -->
    <div class="card mt-4">
        <div class="card-header"><h5 class="mb-0">ğŸ“š æ¨èåˆ·é¢˜ç½‘ç«™</h5></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3"><div class="card website-card h-100"><div class="card-body text-center"><div class="website-icon">ğŸ†</div><h5>Codeforces</h5><p class="text-muted">å…¨çƒçŸ¥åç«èµ›å¹³å°</p><a href="https://codeforces.com/" class="btn btn-primary" target="_blank">è®¿é—®ç½‘ç«™</a></div></div></div>
                <div class="col-md-4 mb-3"><div class="card website-card h-100"><div class="card-body text-center"><div class="website-icon">ğŸ®</div><h5>æ´›è°·</h5><p class="text-muted">å›½å†…çŸ¥åOJ</p><a href="https://www.luogu.com.cn/" class="btn btn-success" target="_blank">è®¿é—®ç½‘ç«™</a></div></div></div>
                <div class="col-md-4 mb-3"><div class="card website-card h-100"><div class="card-body text-center"><div class="website-icon">ğŸ‡¯ğŸ‡µ</div><h5>AtCoder</h5><p class="text-muted">ä¼˜è´¨ç®—æ³•è®­ç»ƒ</p><a href="https://atcoder.jp/" class="btn btn-warning" target="_blank">è®¿é—®ç½‘ç«™</a></div></div></div>
                <div class="col-md-6 mb-3"><div class="card website-card h-100"><div class="card-body text-center"><div class="website-icon">âš”ï¸</div><h5>Virtual Judge</h5><p class="text-muted">å¤šå¹³å°é¢˜ç›®èšåˆ</p><a href="https://vjudge.net/" class="btn btn-info" target="_blank">è®¿é—®ç½‘ç«™</a></div></div></div>
                <div class="col-md-6 mb-3"><div class="card website-card h-100"><div class="card-body text-center"><div class="website-icon">ğŸ‚</div><h5>ç‰›å®¢ç½‘</h5><p class="text-muted">å›½å†…ç«èµ›ä¸é¢è¯•</p><a href="https://ac.nowcoder.com/" class="btn btn-danger" target="_blank">è®¿é—®ç½‘ç«™</a></div></div></div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-5">
        <p>TUST-ACMç®—æ³•å®éªŒå®¤ &copy; 2025 | ç§¯åˆ†è§„åˆ™è¯´æ˜ï¼šæ¯æ¬¡çº¿ä¸‹èµ›ç¬¬ä¸€å7åˆ†ï¼Œç¬¬äºŒå6åˆ†ï¼Œä¾æ¬¡ç±»æ¨ï¼Œè¡¥é¢˜åŠ 1åˆ†</p>
    </footer>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // =========================================================================
    // âš ï¸ å…³é”®é…ç½®åŒºï¼šè¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„ JsonBin Bin ID
    // =========================================================================

    const BIN_ID = '692d62fdd0ea881f400b2564';

    // =========================================================================

    // å…¨å±€æ•°æ®å®¹å™¨ (åˆå§‹ä¸ºç©º)
    let db = {
        contestCount: 0,
        lastUpdate: "",
        totalRanking: [],
        contests: {}
    };

    // é™æ€ XCPC æ•°æ® (æ— éœ€äº‘ç«¯åŒæ­¥ï¼Œç›´æ¥å†™æ­»)
    const xcpcData = [
        { rank: "491/1630", contestName: "2023 å¹¿ä¸œ CPC", date: "2025-11-2", participants: "1630", link: "https://codeforces.com/gym/104369/standings" },
        { rank: "305/1238", contestName: "2022 æ²³å— CPC", date: "2025-11-9", participants: "1238", link: "https://codeforces.com/gym/103941/standings" },
        { rank: "201/468", contestName: "2023 æ¹–å— CPC", date: "2025-11-16", participants: "468", link: "https://codeforces.com/gym/104396/standings/page/2" },
        { rank: "467/1622", contestName: "2023 æ¹–åŒ— CPC", date: "2025-11-23", participants: "1622", link: "https://codeforces.com/gym/104337/standings/friends/true" },
        { rank: "704/2035", contestName: "2024 æ­¦æ±‰ ICPCé›†è®­é˜Ÿ", date: "2025-11-30", participants: "2035", link: "https://codeforces.com/gym/105143/standings" }
    ];

    // ================= é¡µé¢åˆå§‹åŒ–é€»è¾‘ =================
    document.addEventListener('DOMContentLoaded', async function() {
        document.getElementById('new-contest-date').valueAsDate = new Date();
        renderXcpcTable(); // æ¸²æŸ“é™æ€è¡¨æ ¼

        // 1. ä»äº‘ç«¯æ‹‰å–æ•°æ®
        try {
            await loadDataFromCloud();
            console.log("äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ:", db);

            // 2. æ¸²æŸ“æ‰€æœ‰åŠ¨æ€è§†å›¾
            refreshAllViews();

            // 3. åˆå§‹åŒ–è¾“å…¥æ¡†
            initInputTable();

            // 4. å¯ç”¨æäº¤æŒ‰é’®
            document.getElementById('submit-btn').disabled = false;

        } catch (error) {
            console.error("åŠ è½½å¤±è´¥:", error);
            document.getElementById('total-ranking-table').innerHTML = `
                    <tr><td colspan="4" class="text-center text-danger p-5">
                        <h5>æ•°æ®åŠ è½½å¤±è´¥</h5>
                        <p>${error.message}</p>
                        <p class="small">è¯·æ£€æŸ¥ BIN_ID æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…äº‘ç«¯æ•°æ®æ ¼å¼æ˜¯å¦ä¸ºæ ‡å‡† JSONã€‚</p>
                    </td></tr>
                `;
        }
    });

    // ================= äº‘ç«¯äº¤äº’æ ¸å¿ƒå‡½æ•° =================
    async function loadDataFromCloud() {
        // if(BIN_ID === '692d62fdd0ea881f400b2564') {
        //     throw new Error("è¯·å…ˆåœ¨ index.html ä»£ç ä¸­å¡«å…¥æ­£ç¡®çš„ BIN_IDï¼");
        // }

        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: {
                // å¦‚æœä½ çš„ Bin æ˜¯ Public çš„ï¼Œè¿™é‡Œä¸éœ€è¦ Key
                // å¦‚æœæ˜¯ Privateï¼Œè¯·æ·»åŠ  'X-Master-Key': 'YOUR_READ_KEY'
            }
        });

        if (!response.ok) throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
        const json = await response.json();

        // JsonBin v3 è¿”å›çš„æ•°æ®åŒ…è£¹åœ¨ record å­—æ®µä¸­
        if (json.record) {
            db = json.record;
        } else {
            throw new Error("äº‘ç«¯æ•°æ®æ ¼å¼å¼‚å¸¸");
        }
    }

    async function saveDataToCloud(apiKey) {
        db.lastUpdate = new Date().toLocaleString();

        const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': apiKey // å¿…é¡»æä¾›æ­£ç¡®çš„ Key æ‰èƒ½å†™å…¥
            },
            body: JSON.stringify(db)
        });

        if (!response.ok) {
            if(response.status === 401) throw new Error("API Key é”™è¯¯ï¼Œæ‹’ç»è®¿é—®ï¼");
            throw new Error(`ä¿å­˜å¤±è´¥ (Status ${response.status})`);
        }
        return await response.json();
    }

    // ================= è§†å›¾æ¸²æŸ“é€»è¾‘ =================
    function refreshAllViews() {
        // 1. æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡
        document.getElementById('contest-count').innerText = db.contestCount;
        document.getElementById('last-update-text').innerText = `æ›´æ–°æ—¶é—´: ${db.lastUpdate || 'æœªçŸ¥'}`;
        if(db.totalRanking && db.totalRanking.length > 0) {
            document.getElementById('max-score-display').innerText = db.totalRanking[0].totalScore;
        }

        // 2. æ¸²æŸ“æ€»æ’å
        renderTotalTable(db.totalRanking);

        // 3. åŠ¨æ€ç”Ÿæˆæ¯”èµ› Tabs
        const tabList = document.getElementById('contestTabs');
        const tabContent = document.getElementById('contestTabsContent');
        tabList.innerHTML = '';
        tabContent.innerHTML = '';

        // è·å–æ‰€æœ‰æ¯”èµ› Key (c1, c2...) å¹¶æŒ‰æ•°å­—å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨å‰)
        if(db.contests) {
            const keys = Object.keys(db.contests).sort((a, b) => {
                const numA = parseInt(a.replace('c', ''));
                const numB = parseInt(b.replace('c', ''));
                return numB - numA;
            });

            if(keys.length === 0) {
                tabContent.innerHTML = '<div class="p-5 text-center text-muted">æš‚æ— æ¯”èµ›è®°å½•</div>';
            } else {
                keys.forEach((key, index) => {
                    const id = key.replace('c', ''); // æå– "1" from "c1"
                    const data = db.contests[key];
                    const isActive = index === 0; // ç¬¬ä¸€ä¸ª tab æ¿€æ´»
                    createContestTabHTML(id, isActive, data);
                });
            }
        }
    }

    function createContestTabHTML(id, isActive, data) {
        const tabId = `c${id}`;
        const chartId = `scoreChart${id}`;
        const tableId = `ranking-table-${id}`;

        // åˆ›å»º Tab æŒ‰é’®
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = `<button class="nav-link ${isActive?'active':''}" id="${tabId}-tab" data-bs-toggle="tab" data-bs-target="#${tabId}" type="button">ç¬¬${id}åœº</button>`;
        document.getElementById('contestTabs').appendChild(li);

        // åˆ›å»º Content é¢æ¿
        const pane = document.createElement('div');
        pane.className = `tab-pane fade ${isActive?'show active':''}`;
        pane.id = tabId;
        pane.innerHTML = `
                <div class="row pt-3">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">ç¬¬${id}åœºå‘¨èµ›æ’åè¯¦æƒ…</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead><tr><th>æ€»æ’</th><th>å§“å</th><th>æœ¬åœºè¯¦æƒ…</th><th>è¡¥é¢˜</th><th>æœ¬åœºç§¯åˆ†</th></tr></thead>
                                        <tbody id="${tableId}"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-3">ç¬¬${id}åœºå¾—åˆ†åˆ†å¸ƒ</h6>
                                <div style="height:200px"><canvas id="${chartId}"></canvas></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        document.getElementById('contestTabsContent').appendChild(pane);

        // æ¸²æŸ“æ•°æ®
        renderContestTable(tableId, data);

        // æ¸²æŸ“å›¾è¡¨ (å»¶æ—¶ç¡®ä¿ Canvas å·²åˆ›å»º)
        setTimeout(() => {
            renderChart(chartId, data);
        }, 100);
    }

    // ================= ä¸šåŠ¡é€»è¾‘ï¼šæäº¤ç»“ç®— =================
    async function submitAndGenerateReport() {
        const inputs = document.querySelectorAll('.contest-score');
        const checks = document.querySelectorAll('.makeup-check');

        let currentContestResults = [];
        let hasData = false;

        // 1. å†…å­˜ä¸­é¢„è®¡ç®—
        inputs.forEach((input, idx) => {
            const name = input.getAttribute('data-name');
            const score = parseInt(input.value) || 0;
            // æŸ¥æ‰¾å¯¹åº”çš„ checkbox (domé¡ºåºä¸€è‡´)
            const isMakeup = checks[idx].checked;
            const totalAdded = score + (isMakeup ? 1 : 0);

            if (totalAdded > 0) {
                hasData = true;
                // æ›´æ–°æ€»åˆ†
                const student = db.totalRanking.find(s => s.name === name);
                if (student) {
                    student.totalScore += totalAdded;
                    student.justUpdated = true; // æ ‡è®°ç”¨äºåŠ¨ç”»
                }
                // è®°å½•æœ¬åœºè¡¨ç°
                currentContestResults.push({
                    name: name,
                    rawScore: score,
                    makeup: isMakeup,
                    totalScore: totalAdded
                });
            }
        });

        if (!hasData) {
            alert("æœªæ£€æµ‹åˆ°ä»»ä½•åˆ†æ•°è¾“å…¥ï¼");
            return;
        }

        // 2. è¾“å…¥å¯†ç 
        const apiKey = prompt("æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...\n\nè¯·è¾“å…¥ç®¡ç†å‘˜ API Key (X-Master-Key):");
        if (!apiKey) {
            alert("å·²å–æ¶ˆæ“ä½œã€‚");
            return;
        }

        // é”å®šæŒ‰é’®
        const btn = document.getElementById('submit-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = 'â³ æ­£åœ¨åŒæ­¥...';
        btn.disabled = true;

        try {
            // 3. æ•´ç†æ•°æ®
            // æ€»æ¦œé‡æ’
            db.totalRanking.sort((a, b) => b.totalScore - a.totalScore);

            // æ–°å¢åœºæ¬¡ Key
            db.contestCount++;
            const newKey = `c${db.contestCount}`;

            // å¤„ç†æœ¬åœºæ•°æ®æ ¼å¼ (è¡¥å…… totalRank, æ ¼å¼åŒ– contestRank)
            currentContestResults.sort((a, b) => b.totalScore - a.totalScore); // æœ¬åœºé«˜åˆ†åœ¨å‰

            const formattedContestData = currentContestResults.map((item, index) => {
                // è·å–è¯¥å­¦ç”Ÿåœ¨æ€»æ¦œçš„æœ€æ–°æ’å
                const globalRank = db.totalRanking.findIndex(s => s.name === item.name) + 1;
                return {
                    totalRank: globalRank,
                    name: item.name,
                    contestRank: item.rawScore > 0 ? `${index + 1} â†’ +${item.rawScore}` : "-",
                    makeUp: item.makeup ? "+1" : "",
                    totalScore: item.totalScore
                };
            });

            // å†™å…¥ db
            db.contests[newKey] = formattedContestData;

            // 4. å‘é€è¯·æ±‚
            await saveDataToCloud(apiKey);

            alert("âœ… åŒæ­¥æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°ã€‚");

            // åˆ·æ–°é¡µé¢æ˜¾ç¤º
            refreshAllViews();
            initInputTable(); // é‡ç½®è¾“å…¥æ¡†

        } catch (err) {
            alert("âŒ ä¿å­˜å¤±è´¥: " + err.message);
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å›æ»šé€»è¾‘ï¼Œä½†åœ¨ç®€å•åœºæ™¯ä¸‹å»ºè®®æ‰‹åŠ¨åˆ·æ–°
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            // ç§»é™¤åŠ¨ç”»æ ‡è®°
            setTimeout(() => { db.totalRanking.forEach(s => s.justUpdated = false); }, 2000);
        }
    }

    // ================= è¾…åŠ©æ¸²æŸ“å‡½æ•° =================
    function initInputTable() {
        const tbody = document.getElementById('input-score-body');
        tbody.innerHTML = '';

        // æŒ‰å½“å‰æ€»åˆ†æ’åºï¼Œæ–¹ä¾¿å½•å…¥
        const sorted = [...db.totalRanking].sort((a, b) => b.totalScore - a.totalScore);

        sorted.forEach(student => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.totalScore}</td>
                    <td><input type="number" class="form-control form-control-sm score-input contest-score" data-name="${student.name}" placeholder="0" oninput="calcPreview(this)"></td>
                    <td><div class="form-check d-flex justify-content-center"><input class="form-check-input makeup-check" type="checkbox" data-name="${student.name}" onchange="calcPreview(this)"></div></td>
                    <td class="text-primary fw-bold" id="added-${student.name}">0</td>
                `;
            tbody.appendChild(tr);
        });
    }

    function calcPreview(el) {
        const row = el.closest('tr');
        const score = parseInt(row.querySelector('.contest-score').value) || 0;
        const makeup = row.querySelector('.makeup-check').checked ? 1 : 0;
        const added = score + makeup;

        const name = el.getAttribute('data-name'); // æˆ–è€…æ˜¯ row çš„ç¬¬ä¸€ä¸ª td å†…å®¹
        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç”¨ DOM æŸ¥æ‰¾
        const addedTd = row.querySelector('td:last-child');
        addedTd.innerText = added > 0 ? `+${added}` : 0;
        addedTd.style.color = added > 0 ? '#28a745' : '#4e73df';
    }

    function renderTotalTable(data) {
        const tbody = document.getElementById('total-ranking-table');
        tbody.innerHTML = '';

        if(!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        data.forEach((item, index) => {
            let displayRank = index + 1;
            // å¤„ç†åŒåˆ†åŒå
            if(index > 0 && item.totalScore === data[index-1].totalScore) {
                displayRank = data[index-1].displayRank || displayRank;
            }
            item.displayRank = displayRank;

            let rankClass = displayRank === 1 ? 'ranking-1' : (displayRank === 2 ? 'ranking-2' : (displayRank === 3 ? 'ranking-3' : ''));
            let statusHtml = displayRank <= 3 ? '<span class="text-success"><i class="bi bi-fire"></i> é¢†è·‘</span>' : '<span class="text-muted"><i class="bi bi-dash"></i> ç¨³å®š</span>';
            let rowClass = item.justUpdated ? 'highlight-update' : '';

            tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td><span class="ranking-badge ${rankClass}">${displayRank}</span></td>
                        <td>${item.name}</td>
                        <td>${statusHtml}</td>
                        <td><strong>${item.totalScore}</strong></td>
                    </tr>
                `;
        });
    }

    function renderContestTable(elId, data) {
        const tbody = document.getElementById(elId);
        tbody.innerHTML = '';
        if(!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æ— æ•°æ®</td></tr>';
            return;
        }
        data.forEach(item => {
            let rankClass = item.totalRank === 1 ? 'ranking-1' : (item.totalRank === 2 ? 'ranking-2' : (item.totalRank === 3 ? 'ranking-3' : ''));
            let mkClass = item.makeUp ? 'makeup-yes' : 'makeup-no';
            tbody.innerHTML += `
                    <tr>
                        <td><span class="ranking-badge ${rankClass}">${item.totalRank}</span></td>
                        <td>${item.name}</td>
                        <td>${item.contestRank}</td>
                        <td class="${mkClass}">${item.makeUp || '-'}</td>
                        <td><strong>${item.totalScore}</strong></td>
                    </tr>
                `;
        });
    }

    function renderChart(canvasId, data) {
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;

        // é”€æ¯æ—§å®ä¾‹é˜²æ­¢é‡å 
        const existingChart = Chart.getChart(ctx);
        if(existingChart) existingChart.destroy();

        const scores = {};
        if(data) data.forEach(d => { scores[d.totalScore] = (scores[d.totalScore] || 0) + 1; });

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(scores).map(k => `${k}åˆ†`),
                datasets: [{
                    data: Object.values(scores),
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function renderXcpcTable() {
        const tbody = document.getElementById('xcpc-table');
        tbody.innerHTML = '';
        xcpcData.forEach(item => {
            tbody.innerHTML += `
                    <tr>
                        <td>${item.rank}</td>
                        <td><a href="${item.link}" target="_blank" class="text-decoration-none">${item.contestName}</a></td>
                        <td>${item.date}</td>
                        <td>${item.participants}</td>
                    </tr>
                `;
        });
    }
</script>
</body>
</html>
